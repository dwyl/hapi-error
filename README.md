# hapi-error

Intercept errors in your Hapi web app/api and send a *useful* message to the client.

[![Build Status](https://travis-ci.org/dwyl/hapi-error.svg?branch=master)](https://travis-ci.org/dwyl/hapi-error)
[![codecov.io](http://codecov.io/github/dwyl/hapi-error/coverage.svg?branch=master)](http://codecov.io/github/dwyl/hapi-error?branch=master)
[![Code Climate](https://codeclimate.com/github/dwyl/hapi-error/badges/gpa.svg)](https://codeclimate.com/github/dwyl/hapi-error)
[![Dependency Status](https://david-dm.org/dwyl/hapi-error.svg)](https://david-dm.org/dwyl/hapi-error)
[![devDependencies Status](https://david-dm.org/dwyl/hapi-error/dev-status.svg)](https://david-dm.org/dwyl/hapi-error?type=dev)
[![HitCount](https://hitt.herokuapp.com/dwyl/hapi-error.svg)](https://github.com/dwyl/hapi-error)

![dilbert-404-error](https://cloud.githubusercontent.com/assets/194400/17856406/53feeee4-6875-11e6-8480-d493906f6aa1.png)


## *Why*?

By default, `Hapi` does not give people *friendly* error messages.
This plugin lets your app display consistent, friendly & useful
error messages in your Hapi apps.

## *What*?

> Try it: http://hapi-error.herokuapp.com/register/not+va-lid

Under the hood, Hapi uses
[`Boom`](https://github.com/dwyl/learn-hapi#error-handling-with-boom)
to handle errors. These errors are returned as `JSON`. e.g:

If a URL/Endpoint does not exist a `404` error is returned:
![hapi-login-404-error](https://cloud.githubusercontent.com/assets/194400/14770263/06bdc6dc-0a65-11e6-9f9b-80944711a4f1.png)

When a person/client attempts to access a "*restricted*" endpoint without
the proper authentication/authorisation a `401` error is shown:

![hapi-login-401-error](https://cloud.githubusercontent.com/assets/194400/14770276/57022f20-0a65-11e6-86de-d9b8e456b344.png)

And if an *unknown* error occurs on the server, a `500` error is *thrown*:

![localhost-500-error](https://cloud.githubusercontent.com/assets/194400/14770517/98a4b6d6-0a6b-11e6-8448-4b66e3df9a9a.png)

The `hapi-error` plugin *re-purposes* the `Boom` errors (*both the standard Hapi errors and your custom ones*) and instead display human-friendly error *page*:

![hapi-error-screens](https://cloud.githubusercontent.com/assets/194400/15275274/ef9e5402-1abe-11e6-9313-71b11c61f032.png)

> ***Note***: *super basic error page example is just what we came up with in a few minutes, you have full control over what your error page looks like, so use your imagination*!

> ***Note***: if the client expects a JSON response simply define
that in the `headers.accept` and it will still receive the JSON error messages.


## *How*?

Error handling in 3 *easy* steps:

### 1. Install the [plugin](https://www.npmjs.com/package/hapi-error) from npm:

```sh
npm install hapi-error --save
```

### 2. Include the plugin in your Hapi project

Includ the plugin when you `register` your server:

```js
var Hapi = require('hapi');
var Path = require('path');
var Boom = require('boom');
var server = new Hapi.Server();
server.connection({ port: process.env.PORT || 8000 });

server.route([
  {
    method: 'GET',
    path: '/',
    config: {
      handler: function (request, reply) {
        reply('hello world');
      }
    }
  },
  {
    method: 'GET',
    path: '/error',
    config: {
      handler: function (request, reply) {
        reply(new Error('500'));
      }
    }
  }
]);
// this is where we include the hapi-error plugin:
server.register([require('hapi-error'), require('vision')], function (err) {
  if (err) {
    throw err;
  }
  server.views({
    engines: {
      html: require('handlebars') // or Jade or React etc.
    },
    path: Path.resolve(__dirname, './../lib')
  });

  server.start(function (err) {
    if (err) {
      throw err;
    }
    console.log('Visit:', server.info.uri);
  });
});

module.exports = server;
```

> See: [/example/server_example.js](https://github.com/dwyl/hapi-error/blob/master/example/server_example.js) for simple example

### 3. Ensure that you have a View called `error_template`

> Note: `hapi-error` plugin *expects* you are using [`Vision`](https://github.com/hapijs/vision) (*the standard view rendering library for Hapi apps*)
which allows you to use Handlebars, Jade, React, etc. for your templates.

Your `error_template.html` (*or `error_template.ext` `error_template.jsx`*) should make use of the 3 variables it will be passed:

+ `errorTitle` - *the error tile generated by Hapi*
+ `statusCode` - *HTTP statusCode sent to the client *e.g: `404`* (*not found*)
+ `errorMessage` - the *human-friendly error message*

> for an example see: [`/example/error_template.html`](https://github.com/dwyl/hapi-error/blob/master/example/error_template.html)

*That's it*!

*Want more...?* :wink:

## *Custom* Error Messages using `Hoek.assert`

[`Hoek`](https://github.com/hapijs/hoek/blob/master/API.md#assertcondition-message) (*a utility library extensively used internally by Hapi*) has an `assert` method which allows
you to "*throw*" errors one line in your code.

Consider the following Hapi route handler code that is fetching data from a generic Database:

```js
function handler (request, reply) {
  db.get('yourkey', function (err, data) {
    if (err) {
      return reply('error_template', { msg: 'A database error occurred'});
    } else {
      return reply('amazing_app_view', {data: data});
    }
  });
}
```
This can be re-written (*simplified*) using `Hoek.assert`

```js
var Hoek = require('hoek'); // require Hoek somewhere in your code

function handler (request, reply) {
  db.get('yourkey', function (err, data) { // much simpler, right?
    Hoek.assert(!err, 'A database error occurred');
    return reply('amazing_app_view', {data: data});
  }); // this has *exactly* the same effect in much less code.
}
```
#### Explanation:

`Hoek.assert(!err, 'A database error occurred');`
Hoek asserts that there is *no error*. Which means that if
there *is* an error, it will be "*thrown*" with the message you define in the *second argument*.

Output:

![hoek-a-database-error-occured](https://cloud.githubusercontent.com/assets/194400/15276087/58df6fd0-1ad5-11e6-841d-e49495621775.png)

<br />


## Want to pass some more information/handlebar props to your error_template.html?

All you have to do is pass an object to Hoek with an errorMessage property and any other handlebar properties you want!

For example,
```js
Hoek.assert(!error, {errorMessage: 'Oops - there has been an error', email: 'example@example.example', colour:'blue'});
```
You will then be able to use {{email}} and {{colour}} in your error_template.html

##Â *Redirecting* to another endpoint

Sometimes you don't _want_ to show an error page;
_instead_ you want to re-direct to another page.
For example, when your route/page requires the person to be authenticated,
but they have not supplied a valid session/token to view the route/page.

In this situation the default Hapi behaviour is to return a `401` (_unauthorized_) error,
however this is not very _useful_ to the _person_ using your application.

Redirecting to a specific url is _easy_ with `hapi-error`:

```js
const redirectConfig = {
	"401": { // if the statusCode is 401 redirect to /login page/endpoint
		"redirect": "/login"
	}
}
server.register([{
    register: require('hapi-error'),
    options: redirectConfig // pass in your redirect configuration in options
  },
  require('vision')], function (err) {
    // etc.
});  
```

This will `redirect` the client/browser to the `/login` endpoint
and will append a query parameter with the url the person was _trying_ to visit.

e.g: GET /admin --> 401 unauthorized --> redirect to /login?redirect=/admin

> Redirect Example: [/redirect_server_example.js](https://github.com/dwyl/hapi-error/blob/master/test/redirect_server_example.js)

### Are Query Parmeters Preserved?

***Yes***! e.g: if the original url is `/admin?sort=desc`
the redirect url will be: `/login?redirect=/admin?sort=desc`
Such that after the person has logged in they will be re-directed
back to to `/admin?sort=desc` _as desired_.

And it's valid to have multiple question marks in the URL see:
http://stackoverflow.com/questions/2924160/is-it-valid-to-have-more-than-one-question-mark-in-a-url
so the query is preserved and can be used to send the person
to the _exact_ url they requested _after_ they have successfully logged in.

<br />
---

### Under the Hood / Implementation Detail:

When there is an error in the request/response cycle,
the Hapi `request` Object has *useful* error object we can use.

Try logging the `request.response` in one of your Hapi route handlers:

```js
console.log(request.response);
```
A typical `Boom` error has the format:
```js
{ [Error: 500]
  isBoom: true,
  isServer: true,
  data: null,
  output:
   { statusCode: 500,
     payload:
      { statusCode: 500,
        error: 'Internal Server Error',
        message: 'An internal server error occurred' },
     headers: {} },
  reformat: [Function] }
```

The way to *intercept* this error is with a plugin that gets invoked
*before* the response is returned to the client.

A simple **Error Handler Plugin** *example*:

```js
/**
 * register defines our error_handler plugin
 */
exports.register = function error_handler (server, options, next) {
  // onPreResponse intercepts all errors
  server.ext('onPreResponse', function (request, reply) {
    var req = request.response;
    // console.log(request.response);
    if (req.isBoom) { // reply with a slightly more user-friendly error message
      return reply('Sorry, something went wrong, please retrace your steps.')
        .code(req.output.payload.statusCode);
    }
    reply.continue();
  });
  next(); // continue with other plugins
};

exports.register.attributes = {
  pkg: require('../package.json')
};
```
This is the basic setup for you can customise in your Hapi app.
*However* if you want a ["*turnkey*"](https://en.wikipedia.org/wiki/Turnkey)
plugin you can use in your project with user-friendly **HTML error pages**
(*when the client requests `HTML`*) and App/API-friendly **JSON error responses**
(*when the client asks for `JSON`*) then see the code in `/lib/index.js`
and usage instructions above!

## Background Reading & Research

+ Writing *useful* / *friendly* error messages:
https://medium.com/@thomasfuchs/how-to-write-an-error-message-883718173322
